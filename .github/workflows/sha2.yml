name: sha2

on:
  pull_request:
    paths:
      - ".github/workflows/sha2.yml"
      - "sha2/**"
      - "Cargo.*"
  push:
    branches: master

defaults:
  run:
    working-directory: sha2

env:
  RUSTFLAGS: "-Dwarnings"
  CARGO_INCREMENTAL: 0

jobs:
  # Builds for no_std platforms
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        rust:
          - stable
        target:
          - thumbv7em-none-eabi
          - wasm32-unknown-unknown
    steps:
      - uses: actions/checkout@v2
      - uses: risc0/risc0/.github/actions/rustup@main
        with:
          profile: minimal
          toolchain: ${{ matrix.rust }}
          targets: ${{ matrix.target }}
          override: true
      - run: cargo build --no-default-features --target ${{ matrix.target }}

  # Linux tests
  linux:
    strategy:
      matrix:
        include:
          # 32-bit Linux/x86
          - target: i686-unknown-linux-gnu
            rust: stable
            deps: sudo apt update && sudo apt install gcc-multilib

          # 64-bit Linux/x86_64
          - target: x86_64-unknown-linux-gnu
            rust: stable

    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: risc0/risc0/.github/actions/rustup@main
        with:
          profile: minimal
          toolchain: ${{ matrix.rust }}
          targets: ${{ matrix.target }}
          override: true
      - run: ${{ matrix.deps }}
      - run: cargo test --target ${{ matrix.target }} --no-default-features
      - run: cargo test --target ${{ matrix.target }}
      - run: cargo test --target ${{ matrix.target }} --features asm
      - run: cargo test --target ${{ matrix.target }} --all-features

  # macOS tests
  macos:
    strategy:
      matrix:
        rust:
          - stable

    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v2
      - uses: risc0/risc0/.github/actions/rustup@main
        with:
          profile: minimal
          toolchain: ${{ matrix.rust }}
          targets: x86_64-apple-darwin
          override: true
      - run: cargo test --no-default-features
      - run: cargo test
      - run: cargo test --features asm

  risczero-test:
    name: Risc Zero Test
    runs-on: [self-hosted, prod, Linux, cpu]
    steps:
      - uses: actions/checkout@v3
      - uses: risc0/risc0/.github/actions/rustup@main
      # install the risc0 toolchain using the latest release of cargo-risczero
      - run: cargo install cargo-risczero
      - run: cargo risczero install
      - run: git clone https://github.com/risc0/risc0.git
      # rebuild with the latest cargo-risczero with the experimental feature
      - run: cargo install cargo-risczero --path risc0/risc0/cargo-risczero --features experimental
      - run: cargo risczero test -- --release --all-features

  # TODO: remove on MSRV bump to 1.57 or higher
  test-msrv:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: risc0/risc0/.github/actions/rustup@main
        with:
          profile: minimal
          toolchain: 1.41.0
          override: true
      - run: cargo test --no-default-features
      - run: cargo test
